---
AWSTemplateFormatVersion: '2010-09-09'
Description: >-
  Template deploys a Clickstream Analytics Solution that Integrates Amazon Kinesis Firehose, Kinesis Analytics, S3, Redshift and Amazon Elasticsearch in an existing VPC (qs-1pup06r2q).
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Network configuration
        Parameters:
          - AvailabilityZones
          - VPC
      - Label:
          default: Subnet configuration
        Parameters:
          - PublicSubnetA
          - PublicSubnetB
          - PrivateSubnetA
          - PrivateSubnetB
      - Label:
          default: Bastion host configuration
        Parameters:
          - KeyPairName
          - BastionInstanceType
          - RemoteAccessCIDR
          - BastionAMIOS
      - Label:
          default: Web server configuration
        Parameters:
          - AppInstanceType
          - AppKeyPairName
      - Label:
          default: SNS configuration
        Parameters:
          - OperatorEMail
      - Label:
          default: Encrypt data configuration
        Parameters:
          - EncryptData
      - Label:
          default: Amazon ES configuration
        Parameters:
          - ESDomainName
          - ESVersion
          - ESClusterInstanceCount
          - ESInstanceType
          - DedicatedMasterType
          - DedicatedMasterCount
          - IOPS
          - VolumeSize
          - AutomatedSnapshotStartHour
          - VolumeType
      - Label:
          default: Amazon Elasticsearch destination configuration for Amazon Kinesis Data Firehose
        Parameters:
          - ESIndex
          - ESType
          - ESIndexRotation
          - ESBufferInterval
          - ESBufferSize
      - Label:
          default: Amazon Redshift cluster configuration
        Parameters:
          - DatabaseName
          - ClusterType
          - NumberOfNodes
          - NodeType
          - RedshiftPortNumber
          - isDemo
      - Label:
          default: Amazon Redshift configuration for Amazon Kinesis Data Firehose
        Parameters:
          - MasterUser
          - MasterUserPassword
          - RedshiftTableName
          - RedshiftColumns
          - RedshiftBufferInterval
          - RedshiftBufferSize
      - Label:
          default: Amazon S3 destination configuration for Amazon Kinesis Data Firehose
        Parameters:
          - S3BufferInterval
          - S3BufferSize
          - S3DestinationPrefix
      - Label:
          default: Custom website content
        Parameters:
          - WebsiteContent 
      - Label:
          default: AWS Quick Start configuration
        Parameters:
          - QSS3BucketName
          - QSS3KeyPrefix           
    ParameterLabels:
      ESClusterInstanceCount:
        default: Number of instances to run in cluster
      ESInstanceType:
        default: Cluster instance type
      DedicatedMasterType:
        default: Instance type for dedicated master
      DedicatedMasterCount:
        default: Number of dedicated masters in a cluster
      IOPS:
        default: IOPS for cluster
      VolumeSize:
        default: EBS volume size
      AutomatedSnapshotStartHour:
        default: Everyday snapshot time
      VolumeType:
        default: EBS volume type
      VPC:
        default: Existing VPC ID
      PrivateSubnetA:
        default: Existing private subnet ID in AZ-1
      PrivateSubnetB:
        default: Existing private subnet ID in AZ-2
      PublicSubnetA:
        default: Existing public subnet ID in AZ-1
      PublicSubnetB:
        default: Existing public subnet ID in AZ-2
      QSS3BucketName:
        default: Quick Start S3 bucket name
      QSS3KeyPrefix:
        default: Quick Start S3 key prefix       
      OperatorEMail:
        default: Email ID to receive alert notifications
      BastionInstanceType:
        default: Bastion instance type
      BastionAMIOS:
        default: Bastion AMI operating system      
      AppInstanceType:
        default: Application instance type
      KeyPairName:
        default: Bastion host key pair name
      AppKeyPairName:
        default: Application host key pair name
      RemoteAccessCIDR:
        default: Allowed CIDR for external access to bastion
      DatabaseName:
        default: Database name
      ClusterType:
        default: Cluster type
      NumberOfNodes:
        default: Number of nodes
      NodeType: 
        default: Node type
      AvailabilityZones:
        default: Availability Zones
      EncryptData:
        default: Encrypt data at rest
      MasterUser:
        default: Master user name
      MasterUserPassword:
        default: Master user password
      RedshiftTableName:
        default: Table name
      RedshiftColumns:
        default: Column pattern
      RedshiftBufferInterval:
        default: Buffer interval
      RedshiftBufferSize:
        default: Buffer size
      RedshiftPortNumber:
        default: Redshift port number
      isDemo:
        default: Include demo data
      ESIndex:
        default: Index name
      ESType:
        default: Type name
      ESDomainName:
        default: Elasticsearch domain name        
      ESVersion:
        default: Elasticsearch version
      ESIndexRotation:
        default: Index rotation
      ESBufferInterval:
        default: Buffer interval
      ESBufferSize:
        default: Buffer size
      S3BufferInterval:
        default: Buffer interval
      S3BufferSize:
        default: Buffer size
      S3DestinationPrefix:
        default: Destination prefix
      WebsiteContent:
        default: Website content S3 bucket        
Parameters:
  ESClusterInstanceCount:
    Type: String
    Description: For two Availability Zones, you must choose instances in multiples of two.
    Default: 1
  ESInstanceType:
    Type: String
    Description: The instance type for Amzazon ES nodes.
    AllowedValues:
      - t2.small.elasticsearch
      - t2.medium.elasticsearch
      - c4.large.elasticsearch
      - c4.xlarge.elasticsearch
      - c4.2xlarge.elasticsearch
      - c4.4xlarge.elasticsearch
      - c4.8xlarge.elasticsearch
      - m3.medium.elasticsearch
      - m3.large.elasticsearch
      - m3.xlarge.elasticsearch
      - m3.2xlarge.elasticsearch
      - m4.large.elasticsearch
      - m4.xlarge.elasticsearch
      - m4.2xlarge.elasticsearch
      - m4.4xlarge.elasticsearch
      - m4.10xlarge.elasticsearch
      - r3.large.elasticsearch
      - r3.xlarge.elasticsearch
      - r3.2xlarge.elasticsearch
      - r3.4xlarge.elasticsearch
      - r3.8xlarge.elasticsearch
      - r4.large.elasticsearch
      - r4.xlarge.elasticsearch
      - r4.2xlarge.elasticsearch
      - r4.4xlarge.elasticsearch
      - r4.8xlarge.elasticsearch
      - r4.16xlarge.elasticsearch
      - i2.xlarge.elasticsearch
      - i2.2xlarge.elasticsearch      
      - i3.large.elasticsearch
      - i3.xlarge.elasticsearch
      - i3.2xlarge.elasticsearch
      - i3.4xlarge.elasticsearch
      - i3.8xlarge.elasticsearch
      - i3.16xlarge.elasticsearch
    Default: m4.large.elasticsearch
  DedicatedMasterType:
    Type: String
    Description: The master instance type for Amazon ES nodes.
    AllowedValues:
      - t2.small.elasticsearch
      - t2.medium.elasticsearch
      - c4.large.elasticsearch
      - c4.xlarge.elasticsearch
      - c4.2xlarge.elasticsearch
      - c4.4xlarge.elasticsearch
      - c4.8xlarge.elasticsearch
      - m3.medium.elasticsearch
      - m3.large.elasticsearch
      - m3.xlarge.elasticsearch
      - m3.2xlarge.elasticsearch
      - m4.large.elasticsearch
      - m4.xlarge.elasticsearch
      - m4.2xlarge.elasticsearch
      - m4.4xlarge.elasticsearch
      - m4.10xlarge.elasticsearch
      - r3.large.elasticsearch
      - r3.xlarge.elasticsearch
      - r3.2xlarge.elasticsearch
      - r3.4xlarge.elasticsearch
      - r3.8xlarge.elasticsearch
      - r4.large.elasticsearch
      - r4.xlarge.elasticsearch
      - r4.2xlarge.elasticsearch
      - r4.4xlarge.elasticsearch
      - r4.8xlarge.elasticsearch
      - r4.16xlarge.elasticsearch
      - i2.xlarge.elasticsearch
      - i2.2xlarge.elasticsearch      
      - i3.large.elasticsearch
      - i3.xlarge.elasticsearch
      - i3.2xlarge.elasticsearch
      - i3.4xlarge.elasticsearch
      - i3.8xlarge.elasticsearch
      - i3.16xlarge.elasticsearch
    Default: m4.large.elasticsearch
  DedicatedMasterCount:
    Type: String
    Description: The number of dedicated masters to run. Leave the default value for this field, if you don’t want a dedicated master instance.
    AllowedValues:
      - 0
      - 3
      - 5
    Default: 0
  IOPS:
    Type: String
    Description: The provisioned IOPS value must be an integer between 1000 and 16000.
    Default: 0
  VolumeSize:
    Type: String
    Description: IOPS total cluster size in GB (EBS volume size x instance count).
    Default: 10
  AutomatedSnapshotStartHour:
    Type: String
    Description: Schedule automated snapshots. Value should be between 0-23.
    Default: 0
  VolumeType:
    Type: String
    Description: The type of volume used for instances in a cluster.
    AllowedValues:
      - standard
      - gp2
      - io1
    Default: gp2
  VPC:
    Type: AWS::EC2::VPC::Id
    Description: Choose an existing VPC
  PublicSubnetA:
    Type: AWS::EC2::Subnet::Id
    Description: The public subnet in Availability Zone 1
  PublicSubnetB:
    Type: AWS::EC2::Subnet::Id
    Description: The public subnet in Availability Zone 2
  PrivateSubnetA:
    Type: AWS::EC2::Subnet::Id
    Description: The private subnet in Availability Zone 1
  PrivateSubnetB:
    Type: AWS::EC2::Subnet::Id
    Description: The private subnet in Availability Zone 2
  QSS3BucketName:
    AllowedPattern: ^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$
    ConstraintDescription: Quick start bucket name can include numbers, lowercase
      letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen
      (-).
    Default: aws-quickstart
    Description: The S3 bucket you have created for your copy of Quick Start assets, if you decide to customize or extend the Quick Start for your own use. The bucket name can include numbers, lowercase letters, uppercase letters, and hyphens, but should not start or end with a hyphen.
    Type: String
  QSS3KeyPrefix:
    AllowedPattern: ^[0-9a-zA-Z-/]*$
    ConstraintDescription: Quick Start key prefix can include numbers, lowercase letters,
      uppercase letters, hyphens (-), and forward slash (/). It cannot start or end
      with forward slash (/) because they are automatically appended.
    Default: quickstart-ct-clickstream-analytics/
    Description: The S3 key name prefix used to simulate a folder for your copy of Quick Start assets, if you decide to customize or extend the Quick Start for your own use. This prefix can include numbers, lowercase letters, uppercase letters, hyphens, and forward slashes.
    Type: String
  OperatorEMail:
    Description: The email address to notify you, if there are any scaling operations.
    Type: String
    AllowedPattern: ([a-zA-Z0-9_\-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)
    ConstraintDescription: Must be a valid email address.
  BastionAMIOS:
    AllowedValues:
      - Amazon-Linux-HVM
    Default: Amazon-Linux-HVM
    Description: The Amazon Linux distribution for the Amazon Machine Image (AMI) to be used for the bastion instances.
    Type: String
  BastionInstanceType:
    Description: The bastion host EC2 instance type
    Type: String
    Default: t2.micro
    AllowedValues:
    - t2.nano
    - t2.micro
    - t2.small
    - t2.medium
    - t2.large
    - m3.large
    - m3.xlarge
    - m3.2xlarge
    - m4.large
    - m4.xlarge
    - m4.2xlarge
    - m4.4xlarge
    ConstraintDescription: must be a valid EC2 instance type.
  AppInstanceType:
    Description: App server EC2 instance type
    Type: String
    Default: t2.micro
    AllowedValues:
    - t1.micro
    - t2.nano
    - t2.micro
    - t2.small
    - t2.medium
    - t2.large
    - m1.small
    - m1.medium
    - m1.large
    - m1.xlarge
    - m2.xlarge
    - m2.2xlarge
    - m2.4xlarge
    - m3.medium
    - m3.large
    - m3.xlarge
    - m3.2xlarge
    - m4.large
    - m4.xlarge
    - m4.2xlarge
    - m4.4xlarge
    - m4.10xlarge
    - c1.medium
    - c1.xlarge
    - c3.large
    - c3.xlarge
    - c3.2xlarge
    - c3.4xlarge
    - c3.8xlarge
    - c4.large
    - c4.xlarge
    - c4.2xlarge
    - c4.4xlarge
    - c4.8xlarge
    - g2.2xlarge
    - g2.8xlarge
    - r3.large
    - r3.xlarge
    - r3.2xlarge
    - r3.4xlarge
    - r3.8xlarge
    - i2.xlarge
    - i2.2xlarge
    - i2.4xlarge
    - i2.8xlarge
    - d2.xlarge
    - d2.2xlarge
    - d2.4xlarge
    - d2.8xlarge
    - hi1.4xlarge
    - hs1.8xlarge
    - cr1.8xlarge
    - cc2.8xlarge
    ConstraintDescription: must be a valid EC2 instance type.
  KeyPairName:
    Description: A public/private key pair, which allows you to connect securely to your instance after it launches. This is the key pair you created in your preferred AWS Region; see the Technical requirements section. If you do not have one in this region, please create it before continuing.
    Type: AWS::EC2::KeyPair::KeyName
  AppKeyPairName:
    Description: Public/private key pairs allow you to securely connect to your application instance after it launches. If you do not have one in this region, please create it before continuing
    Type: AWS::EC2::KeyPair::KeyName
  RemoteAccessCIDR:
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: CIDR block parameter must be in the form x.x.x.x/16-28
    Description: A CIDR block that’s allowed external access to the bastion. We recommend that you use a constrained CIDR range to reduce the potential of inbound attacks from unknown IP addresses (see http://checkip.dyndns.org/)
    Type: String
  AvailabilityZones:
    Description: List of Availability Zone to use for the subnets in the VPC. Only
      two Availability Zone are used for this deployment, and the logical order of
      your selections is preserved.
    Type: List<AWS::EC2::AvailabilityZone::Name>
  S3DestinationPrefix:
    Description: The name of the prefix where the aggregated data will be stored.
    Type: String
    Default: AggregatedData
  S3BufferInterval:
    Description: The number of seconds to buffer data before delivering to Amazon S3 (60 to 900).
    Type: Number
    Default: 300
    MinValue: 60
    MaxValue: 900
  S3BufferSize:
    Description: MB of data to buffer before delivering to Amazon S3 (1 to 128).
    Type: Number
    Default: 5
    MinValue: 1
    MaxValue: 128
  EncryptData:
    Description: Set to yes to encrypt the data as it leaves your Amazon Kinesis Data Firehose delivery stream.
    Type: String
    AllowedValues:
      - 'yes'
      - 'no'
    Default: 'no'
  ESDomainName:
    Description: The user-defined Amazon ES domain name.
    Type: String    
  ESVersion:
    Description: The user-defined Amazon ES version.
    Type: String
    AllowedValues:
      - 6.3
      - 6.2
      - 6.0
      - 5.6
      - 5.3
      - 5.1
      - 2.3
      - 1.5
    Default: 6.3
  ESIndex:
    Description: The index name of the Amazon ES domain.
    Type: String
  ESType:
    Description: The name of the Amazon ES type.
    Type: String
  ESIndexRotation:
    Description: The frequency at which the Amazon ES index will be rotated.
    Type: String
    AllowedValues:
      - NoRotation
      - OneHour
      - OneDay
      - OneWeek
      - OneMonth
    Default: NoRotation
  ESBufferInterval:
    Description: The number of seconds to buffer data before delivering to Amazon S3 to be copied to Amazon ES (60 to 900).
    Type: Number
    Default: 300
    MinValue: 60
    MaxValue: 900
  ESBufferSize:
    Description: MB of data to buffer before delivering to Amazon S3 to be copied to Amazon ES (1 to 100).
    Type: Number
    Default: 5
    MinValue: 1
    MaxValue: 100
  DatabaseName:
    Description: The name of the first database to be created when the Amazon Redshift cluster is created.
    Type: String
    AllowedPattern: "([a-z]|[0-9])+"
  ClusterType:
    Description: The type of Amazon Redshift cluster.
    Type: String
    Default: single-node
    AllowedValues:
    - single-node
    - multi-node
  NumberOfNodes:
    Description: The number of compute nodes in the Amazon Redshift cluster. For multi-node clusters, the NumberOfNodes parameter must be greater than 1.
    Type: Number
    Default: '1'
  NodeType:
    Description: The type of Amazon Redshift node to be provisioned.
    Type: String
    Default: dc2.large
    AllowedValues:
    - ds2.xlarge
    - ds2.8xlarge
    - dc1.large
    - dc1.8xlarge
    - dc2.large
    - dc2.8xlarge
  MasterUserPassword:
    Description: The master user password for the Amazon Redshift cluster.
    NoEcho: 'true'
    Type: String
  MasterUser:
    Description: The name of the master user of the Amazon Redshift cluster.
    Type: String
    Default: masteruser
  RedshiftBufferInterval:
    Description: The number of seconds to buffer data before delivering to Amazon Redshift (60 to 900).
    Type: Number
    Default: 300
    MinValue: 60
    MaxValue: 900
  RedshiftBufferSize:
    Description: MB of data to buffer before delivering to Amazon Redshift (1 to 128).
    Type: Number
    Default: 5
    MinValue: 1
    MaxValue: 128
  RedshiftTableName:
    Description: The name of the table in the Amazon Redshift cluster. Do not change it.
    Type: String
    Default: apache_logs.access_logs
  RedshiftColumns:
    Description: Comma-separated list of the columns in the destination Amazon Redshift table.
    Type: String
  RedshiftPortNumber:
    Description: The Amazon Redshift publicly accessible port number.
    Type: String
    Default: '5439'
  isDemo:
    Description: Set to 'yes' if you want to ingest demo data into Amazon Redshift.
    Type: String
    AllowedValues:
      - 'yes'
      - 'no'
    Default: 'no'
  WebsiteContent:
    Description: This is the S3 location where your custom website contents are uploaded. This Quick Start will deploy your website from this location. Leave blank if there is no site to deploy.
    Type: String 
Mappings:
  InstanceType2Arch:
    t1.micro:
      Arch: PV64
    t2.nano:
      Arch: HVM64
    t2.micro:
      Arch: HVM64
    t2.small:
      Arch: HVM64
    t2.medium:
      Arch: HVM64
    t2.large:
      Arch: HVM64
    m1.small:
      Arch: PV64
    m1.medium:
      Arch: PV64
    m1.large:
      Arch: PV64
    m1.xlarge:
      Arch: PV64
    m2.xlarge:
      Arch: PV64
    m2.2xlarge:
      Arch: PV64
    m2.4xlarge:
      Arch: PV64
    m3.medium:
      Arch: HVM64
    m3.large:
      Arch: HVM64
    m3.xlarge:
      Arch: HVM64
    m3.2xlarge:
      Arch: HVM64
    m4.large:
      Arch: HVM64
    m4.xlarge:
      Arch: HVM64
    m4.2xlarge:
      Arch: HVM64
    m4.4xlarge:
      Arch: HVM64
    m4.10xlarge:
      Arch: HVM64
    c1.medium:
      Arch: PV64
    c1.xlarge:
      Arch: PV64
    c3.large:
      Arch: HVM64
    c3.xlarge:
      Arch: HVM64
    c3.2xlarge:
      Arch: HVM64
    c3.4xlarge:
      Arch: HVM64
    c3.8xlarge:
      Arch: HVM64
    c4.large:
      Arch: HVM64
    c4.xlarge:
      Arch: HVM64
    c4.2xlarge:
      Arch: HVM64
    c4.4xlarge:
      Arch: HVM64
    c4.8xlarge:
      Arch: HVM64
    g2.2xlarge:
      Arch: HVMG2
    g2.8xlarge:
      Arch: HVMG2
    r3.large:
      Arch: HVM64
    r3.xlarge:
      Arch: HVM64
    r3.2xlarge:
      Arch: HVM64
    r3.4xlarge:
      Arch: HVM64
    r3.8xlarge:
      Arch: HVM64
    i2.xlarge:
      Arch: HVM64
    i2.2xlarge:
      Arch: HVM64
    i2.4xlarge:
      Arch: HVM64
    i2.8xlarge:
      Arch: HVM64
    d2.xlarge:
      Arch: HVM64
    d2.2xlarge:
      Arch: HVM64
    d2.4xlarge:
      Arch: HVM64
    d2.8xlarge:
      Arch: HVM64
    hi1.4xlarge:
      Arch: HVM64
    hs1.8xlarge:
      Arch: HVM64
    cr1.8xlarge:
      Arch: HVM64
    cc2.8xlarge:
      Arch: HVM64
  AWSRegionArch2AMI:
    us-east-1:
      PV64: ami-2a69aa47
      HVM64: ami-6869aa05
      HVMG2: ami-61e27177
    us-west-2:
      PV64: ami-7f77b31f
      HVM64: ami-7172b611
      HVMG2: ami-60aa3700
    us-west-1:
      PV64: ami-a2490dc2
      HVM64: ami-31490d51
      HVMG2: ami-4b694d2b
    eu-west-1:
      PV64: ami-4cdd453f
      HVM64: ami-f9dd458a
      HVMG2: ami-2955524f
    eu-west-2:
      PV64: NOT_SUPPORTED
      HVM64: ami-886369ec
      HVMG2: NOT_SUPPORTED
    eu-central-1:
      PV64: ami-6527cf0a
      HVM64: ami-ea26ce85
      HVMG2: ami-81ac71ee
    ap-northeast-1:
      PV64: ami-3e42b65f
      HVM64: ami-374db956
      HVMG2: ami-46220c21
    ap-northeast-2:
      PV64: NOT_SUPPORTED
      HVM64: ami-2b408b45
      HVMG2: NOT_SUPPORTED
    ap-southeast-1:
      PV64: ami-df9e4cbc
      HVM64: ami-a59b49c6
      HVMG2: ami-c212aba1
    ap-southeast-2:
      PV64: ami-63351d00
      HVM64: ami-dc361ebf
      HVMG2: ami-0ad2db69
    ap-south-1:
      PV64: NOT_SUPPORTED
      HVM64: ami-ffbdd790
      HVMG2: ami-ca3042a5
    us-east-2:
      PV64: NOT_SUPPORTED
      HVM64: ami-f6035893
      HVMG2: NOT_SUPPORTED
    ca-central-1:
      PV64: NOT_SUPPORTED
      HVM64: ami-730ebd17
      HVMG2: NOT_SUPPORTED
    sa-east-1:
      PV64: ami-1ad34676
      HVM64: ami-6dd04501
      HVMG2: NOT_SUPPORTED
    cn-north-1:
      PV64: ami-77559f1a
      HVM64: ami-8e6aa0e3
      HVMG2: NOT_SUPPORTED
  RegionMap: 
    us-east-1: 
      RedshiftInboundTraffic: 52.70.63.192/27
    us-east-2:
      RedshiftInboundTraffic: 13.58.135.96/27
    us-west-2:
      RedshiftInboundTraffic: 52.89.255.224/27
    us-west-1:
      RedshiftInboundTraffic: 13.57.135.192/27
    eu-central-1:
      RedshiftInboundTraffic: 35.158.127.160/27
    ca-central-1:
      RedshiftInboundTraffic: 35.183.92.128/27
    eu-west-1:
      RedshiftInboundTraffic: 52.19.239.192/27
    eu-west-2:
      RedshiftInboundTraffic: 18.130.1.96/27
    eu-west-3:
      RedshiftInboundTraffic: 35.180.1.96/27
    ap-southeast-1:
      RedshiftInboundTraffic: 13.228.64.192/27
    ap-southeast-2:
      RedshiftInboundTraffic: 13.210.67.224/27
    ap-northeast-1:
      RedshiftInboundTraffic: 13.113.196.224/27
    ap-northeast-2:
      RedshiftInboundTraffic: 13.209.1.64/27
    ap-south-1:
      RedshiftInboundTraffic: 13.232.67.32/27
    sa-east-1:
      RedshiftInboundTraffic: 18.228.1.128/27
  AWSQuickSightIPMap:
    ap-northeast-1: 
      QuickSightIP: 13.113.244.32/27
    ap-southeast-1: 
      QuickSightIP: 13.229.254.0/27
    ap-southeast-2: 
      QuickSightIP: 54.153.249.96/27
    eu-central-1: 
      QuickSightIP: 35.158.127.192/27
    eu-west-1: 
      QuickSightIP: 52.210.255.224/27
    eu-west-2: 
      QuickSightIP: 35.177.218.0/27
    us-east-1: 
      QuickSightIP: 52.23.63.224/27
    us-east-2: 
      QuickSightIP: 52.15.247.160/27
    us-west-2: 
      QuickSightIP: 54.70.204.128/27
    us-west-1:
      QuickSightIP: none
    ca-central-1:
      QuickSightIP: none
    eu-west-3:
      QuickSightIP: none
    eu-north-1:
      QuickSightIP: none
    ap-east-1:
      QuickSightIP: none
    ap-northeast-2:
      QuickSightIP: none
    ap-northeast-3:
      QuickSightIP: none
    ap-south-1:
      QuickSightIP: none
    me-south-1:
      QuickSightIP: none
    sa-east-1:
      QuickSightIP: none

Conditions:
  IsMultiNodeCluster:
    Fn::Equals:
    - Ref: ClusterType
    - multi-node
  EncryptData: !Equals
    - !Ref 'EncryptData'
    - 'yes'
  NoEncryption: !Equals
    - !Ref 'EncryptData'
    - 'no'  
  isDemos: !Equals
    - !Ref 'isDemo'
    - 'yes'
  isDemon: !Equals
    - !Ref 'isDemo'
    - 'no'    
  HasDedicatedMasterNodes: !Not [!Equals [!Ref DedicatedMasterCount, 0]]
  HasSingleClusterInstance: !Equals [!Ref ESClusterInstanceCount, '1']
  isQuickSightRegionIP:
    !Not [!Equals [!FindInMap [ AWSQuickSightIPMap, !Ref "AWS::Region", QuickSightIP ], "none"]]

Resources:
  BastionStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::Sub: https://${QSS3BucketName}.s3.amazonaws.com/${QSS3KeyPrefix}submodules/quickstart-linux-bastion/templates/linux-bastion.template
      Parameters:
        BastionAMIOS:
          Ref: BastionAMIOS
        BastionInstanceType:
          Ref: BastionInstanceType
        KeyPairName:
          Ref: KeyPairName
        PublicSubnet1ID:
          Ref: PublicSubnetA
        PublicSubnet2ID:
          Ref: PublicSubnetB
        QSS3BucketName:
          Ref: QSS3BucketName
        QSS3KeyPrefix:
          Fn::Sub: ${QSS3KeyPrefix}submodules/quickstart-linux-bastion/
        RemoteAccessCIDR:
          Ref: RemoteAccessCIDR
        VPCID:
          Ref: VPC

  AppSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: HTTP Access to VPC CidrBlock
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref PublicLoadBalancerSG
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          SourceSecurityGroupId: !GetAtt BastionStack.Outputs.BastionSecurityGroupID
  AppInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref 'AppRole'
  AppPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: AppPolicy
      PolicyDocument:
        Statement:
          - Effect: Allow
            Action:
              - "firehose:DeleteDeliveryStream"
              - "firehose:PutRecord"
              - "firehose:PutRecordBatch"
              - "firehose:UpdateDestination"
            Resource: '*'
          - Effect: Allow
            Action:
              - "cloudwatch:PutMetricData"
            Resource: '*'
          - Effect: Allow
            Action:
              - "s3:AbortMultipartUpload"
              - "s3:GetBucketLocation"
              - "s3:Get*"
              - "s3:ListBucket"
              - "s3:ListBucketMultipartUploads"
              - "s3:Put*"
              - "s3:GetBucketAcl"
              - "s3:ListAllMyBuckets"
            Resource: '*'
          - Effect: Allow
            Action:
              - "cloudformation:DescribeStackResource"
              - "cloudformation:SignalResource"
            Resource: '*'
          - Effect: Allow
            Action:
              - "sts:AssumeRole"
            Resource: '*'
      Roles:
        - !Ref 'AppRole'
  AppRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
  EncryptionKey:
    Type: AWS::KMS::Key
    Condition: EncryptData
    Properties:
      Description: KMS key generated to encrypt aggregated Kinesis Analytics data.
      EnableKeyRotation: true
      KeyPolicy:
        Id: KMS key policy
        Version: '2012-10-17'
        Statement:
          - Sid: Enable IAM User Permissions
            Effect: Allow
            Principal:
              AWS:
                - !Join
                  - ''
                  - - 'arn:aws:iam::'
                    - !Ref 'AWS::AccountId'
                    - :root
            Action: kms:*
            Resource: '*'
          - Sid: Allow access for Key Administrators
            Effect: Allow
            Principal:
              AWS:
                - !Join
                  - ''
                  - - 'arn:aws:iam::'
                    - !Ref 'AWS::AccountId'
                    - :root
            Action:
              - kms:Create*
              - kms:Describe*
              - kms:Enable*
              - kms:List*
              - kms:Put*
              - kms:Update*
              - kms:Revoke*
              - kms:Disable*
              - kms:Get*
              - kms:Delete*
              - kms:ScheduleKeyDeletion
              - kms:CancelKeyDeletion
            Resource: '*'
          - Sid: Allow use of the key
            Effect: Allow
            Principal:
              AWS:
                - !Join
                  - ''
                  - - 'arn:aws:iam::'
                    - !Ref 'AWS::AccountId'
                    - :root
            Action:
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:DescribeKey
            Resource: '*'
          - Sid: Allow attachment of persistent resources
            Effect: Allow
            Principal:
              AWS:
                - !Join
                  - ''
                  - - 'arn:aws:iam::'
                    - !Ref 'AWS::AccountId'
                    - :root
            Action:
              - kms:CreateGrant
              - kms:ListGrants
              - kms:RevokeGrant
            Resource: '*'
            Condition:
              Bool:
                kms:GrantIsForAWSResource: true
  KMSAlias:
    Type: AWS::KMS::Alias
    Condition: EncryptData
    Properties:
      AliasName: !Join
        - ''
        - - alias/key-
          - !Ref 'AWS::StackName'
      TargetKeyId: !GetAtt 'EncryptionKey.Arn'
  StreamingAnalyticsBucket:
    Type: AWS::S3::Bucket
    Properties:
      VersioningConfiguration:
        Status: "Enabled"
    DeletionPolicy: Retain
  FIrehoseToS3Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - firehose.amazonaws.com
            Action:
              - sts:AssumeRole
            Condition:
              StringEquals:
                sts:ExternalId: !Ref 'AWS::AccountId'
      Policies:
        - PolicyName: !Join
            - ''
            - - Firehose-to-S3-Delivery-
              - !Ref 'AWS::StackName'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: ''
                Effect: Allow
                Action:
                  - s3:AbortMultipartUpload
                  - s3:GetBucketLocation
                  - s3:GetObject
                  - s3:ListBucket
                  - s3:ListBucketMultipartUploads
                  - s3:PutObject
                Resource:
                  - !Join
                    - ''
                    - - 'arn:aws:s3:::'
                      - !Ref 'StreamingAnalyticsBucket'
                  - !Join
                    - ''
                    - - 'arn:aws:s3:::'
                      - !Ref 'StreamingAnalyticsBucket'
                      - /*
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:GenerateDataKey
                Resource:
                  - !If
                    - NoEncryption
                    - !Join
                      - ''
                      - - 'arn:aws:kms:'
                        - !Ref 'AWS::Region'
                        - ':'
                        - !Ref 'AWS::AccountId'
                        - :key/placeholder-kms-id
                    - !GetAtt 'EncryptionKey.Arn'
                Condition:
                  StringEquals:
                    kms:ViaService: !Join
                      - ''
                      - - s3.
                        - !Ref 'AWS::Region'
                        - .amazonaws.com
                  StringLike:
                    kms:EncryptionContext:aws:s3:arn: !Join
                      - ''
                      - - 'arn:aws:s3:::'
                        - !Ref 'StreamingAnalyticsBucket'
                        - /
                        - !Ref 'S3DestinationPrefix'
                        - /*
              - Sid: ''
                Effect: Allow
                Action:
                  - logs:PutLogEvents
                Resource:
                  - '*'
  FIrehoseToS3:
    Type: AWS::KinesisFirehose::DeliveryStream
    Properties:
      S3DestinationConfiguration:
        BucketARN: !Join
          - ''
          - - 'arn:aws:s3:::'
            - !Ref 'StreamingAnalyticsBucket'
        BufferingHints:
          IntervalInSeconds: !Ref 'S3BufferInterval'
          SizeInMBs: !Ref 'S3BufferSize'
        CloudWatchLoggingOptions: 
          Enabled: true
          LogGroupName: !Ref S3CloudwatchLogsGroup
          LogStreamName: !Ref S3LogStream
        CompressionFormat: UNCOMPRESSED
        EncryptionConfiguration:
          KMSEncryptionConfig: !If
            - NoEncryption
            - !Ref 'AWS::NoValue'
            - AWSKMSKeyARN: !GetAtt 'EncryptionKey.Arn'
          NoEncryptionConfig: !If
            - NoEncryption
            - NoEncryption
            - !Ref 'AWS::NoValue'
        Prefix: !Join
          - ''
          - - !Ref 'S3DestinationPrefix'
            - /
        RoleARN: !GetAtt 'FIrehoseToS3Role.Arn'
  esroleforsl:
    Type: "AWS::IAM::ServiceLinkedRole"
    Properties:
      AWSServiceName: "es.amazonaws.com"
      Description: "ElasticsearchServiceLinkCreate"
  ESDomain:
    Type: AWS::Elasticsearch::Domain
    Properties:
      DomainName: !Ref 'ESDomainName'
      ElasticsearchVersion: !Ref ESVersion
      ElasticsearchClusterConfig:      
        DedicatedMasterEnabled: !If [HasDedicatedMasterNodes, true, false]
        InstanceCount: !Ref ESClusterInstanceCount
        ZoneAwarenessEnabled: !If [HasSingleClusterInstance, false, true]
        InstanceType: !Ref ESInstanceType
        DedicatedMasterType: !If [HasDedicatedMasterNodes, !Ref DedicatedMasterType, !Ref 'AWS::NoValue']
        DedicatedMasterCount: !If [HasDedicatedMasterNodes, !Ref DedicatedMasterCount, !Ref 'AWS::NoValue']
      EBSOptions:
        EBSEnabled: true
        Iops: !Ref IOPS
        VolumeSize: !Ref VolumeSize
        VolumeType: !Ref VolumeType
      SnapshotOptions:
        AutomatedSnapshotStartHour: !Ref AutomatedSnapshotStartHour
      AccessPolicies:
        Version: '2012-10-17'
        Statement:
          - 
            Principal:
              AWS: "*"
            Action:
            - "es:ESHttpGet"
            - "es:ESHttpPut"
            - "es:ESHttpPost"
            - "es:ESHttpHead"
            Effect: "Allow"
            Condition:
               IpAddress:
                 aws:SourceIp:
                   - Ref: RemoteAccessCIDR
            Resource: !Sub 'arn:aws:es:${AWS::Region}:${AWS::AccountId}:domain/${ESDomainName}/*'
      AdvancedOptions:
        rest.action.multi.allow_explicit_index: 'true'
        indices.fielddata.cache.size: '100'
        indices.query.bool.max_clause_count: '1024'
  ElasticSearchDeliveryRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - firehose.amazonaws.com
            Action:
              - sts:AssumeRole
            Condition:
              StringEquals:
                sts:ExternalId: !Ref 'AWS::AccountId'
      Policies:
        - PolicyName: !Join
            - ''
            - - Firehose-to-ElasticSearch-Delivery-
              - !Ref 'AWS::StackName'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: ''
                Effect: Allow
                Action:
                  - s3:AbortMultipartUpload
                  - s3:GetBucketLocation
                  - s3:GetObject
                  - s3:ListBucket
                  - s3:ListBucketMultipartUploads
                  - s3:PutObject
                Resource:
                  - !Join
                    - ''
                    - - 'arn:aws:s3:::'
                      - !Ref 'StreamingAnalyticsBucket'
                  - !Join
                    - ''
                    - - 'arn:aws:s3:::'
                      - !Ref 'StreamingAnalyticsBucket'
                      - /*
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:GenerateDataKey
                Resource:
                  - !If
                    - NoEncryption
                    - !Join
                      - ''
                      - - 'arn:aws:kms:'
                        - !Ref 'AWS::Region'
                        - ':'
                        - !Ref 'AWS::AccountId'
                        - :key/placeholder-kms-id
                    - !GetAtt 'EncryptionKey.Arn'
                Condition:
                  StringEquals:
                    kms:ViaService: !Join
                      - ''
                      - - s3.
                        - !Ref 'AWS::Region'
                        - .amazonaws.com
                  StringLike:
                    kms:EncryptionContext:aws:s3:arn: !Join
                      - ''
                      - - 'arn:aws:s3:::'
                        - !Ref 'StreamingAnalyticsBucket'
                        - /ESDeliveryBackup/*
              - Sid: ''
                Effect: Allow
                Action:
                  - es:DescribeElasticsearchDomain
                  - es:DescribeElasticsearchDomains
                  - es:DescribeElasticsearchDomainConfig
                  - es:ESHttpPost
                  - es:ESHttpPut
                Resource:
                  - !Join
                    - ''
                    - - 'arn:aws:es:'
                      - !Ref 'AWS::Region'
                      - ':'
                      - !Ref 'AWS::AccountId'
                      - :domain/
                      - !Ref 'ESDomainName'
                  - !Join
                    - ''
                    - - 'arn:aws:es:'
                      - !Ref 'AWS::Region'
                      - ':'
                      - !Ref 'AWS::AccountId'
                      - :domain/
                      - !Ref 'ESDomainName'
                      - /*
              - Sid: ''
                Effect: Allow
                Action:
                  - logs:PutLogEvents
                Resource:
                  - '*'
  FIrehoseToElasticsearch:
    Type: AWS::KinesisFirehose::DeliveryStream
    DependsOn: ElasticSearchDeliveryRole
    Properties:
      ElasticsearchDestinationConfiguration:
        BufferingHints:
          IntervalInSeconds: !Ref 'ESBufferInterval'
          SizeInMBs: !Ref 'ESBufferSize'
        CloudWatchLoggingOptions: 
          Enabled: true
          LogGroupName: !Ref ESCloudwatchLogsGroup
          LogStreamName: !Ref ESLogStream
        DomainARN: !Join
          - ''
          - - 'arn:aws:es:'
            - !Ref 'AWS::Region'
            - ':'
            - !Ref 'AWS::AccountId'
            - :domain/
            - !Ref 'ESDomain'
        IndexName: !Ref 'ESIndex'
        IndexRotationPeriod: !Ref 'ESIndexRotation'
        RetryOptions:
          DurationInSeconds: 300
        RoleARN: !GetAtt 'ElasticSearchDeliveryRole.Arn'
        S3BackupMode: AllDocuments
        S3Configuration:
          BucketARN: !Join
            - ''
            - - 'arn:aws:s3:::'
              - !Ref 'StreamingAnalyticsBucket'
          BufferingHints:
            IntervalInSeconds: !Ref 'ESBufferInterval'
            SizeInMBs: !Ref 'ESBufferSize'
          CompressionFormat: UNCOMPRESSED
          EncryptionConfiguration:
            KMSEncryptionConfig: !If
              - NoEncryption
              - !Ref 'AWS::NoValue'
              - AWSKMSKeyARN: !GetAtt 'EncryptionKey.Arn'
            NoEncryptionConfig: !If
              - NoEncryption
              - NoEncryption
              - !Ref 'AWS::NoValue'
          Prefix: ESDeliveryBackup/
          RoleARN: !GetAtt 'ElasticSearchDeliveryRole.Arn'
        TypeName: !Ref 'ESType'
  RedshiftCluster:
    Type: AWS::Redshift::Cluster
    DependsOn: RedshiftDeliveryRole
    Properties:
      ClusterType: !Ref ClusterType
      NumberOfNodes:
        Fn::If:
        - IsMultiNodeCluster
        - Ref: NumberOfNodes
        - Ref: AWS::NoValue
      NodeType:
        Ref: NodeType
      DBName:
        Ref: DatabaseName
      IamRoles:
        - !GetAtt RedshiftDeliveryRole.Arn
      MasterUsername:
        Ref: MasterUser
      MasterUserPassword:
        Ref: MasterUserPassword
      ClusterParameterGroupName:
        Ref: RedshiftClusterParameterGroup
      VpcSecurityGroupIds:
      - Ref: RSDefaultSG
      ClusterSubnetGroupName:
        Ref: RedshiftClusterSubnetGroup
      PubliclyAccessible: true
      Port:
        Ref: RedshiftPortNumber
  RedshiftClusterParameterGroup:
    Type: AWS::Redshift::ClusterParameterGroup
    Properties:
      Description: Cluster parameter group
      ParameterGroupFamily: redshift-1.0
      Parameters:
      - ParameterName: enable_user_activity_logging
        ParameterValue: 'true'
  RedshiftClusterSubnetGroup:
    Type: AWS::Redshift::ClusterSubnetGroup
    Properties:
      Description: Cluster subnet group
      SubnetIds:
      - Ref: PublicSubnetA
      - Ref: PublicSubnetB
  RSDefaultSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: RSSecurity group
      SecurityGroupIngress:
      - CidrIp: !FindInMap
               - RegionMap
               - !Ref 'AWS::Region'
               - RedshiftInboundTraffic
        FromPort:
          Ref: RedshiftPortNumber
        ToPort:
          Ref: RedshiftPortNumber
        IpProtocol: tcp
        Description: Kinesis Data Firehose CIDR block 
      - CidrIp: !Ref RemoteAccessCIDR
        FromPort:
          Ref: RedshiftPortNumber
        ToPort:
          Ref: RedshiftPortNumber
        IpProtocol: tcp
      - CidrIp: !Ref RemoteAccessCIDR
        FromPort:
          Ref: RedshiftPortNumber
        ToPort:
          Ref: RedshiftPortNumber
        IpProtocol: tcp
      - IpProtocol: tcp
        FromPort:
          Ref: RedshiftPortNumber
        ToPort:
          Ref: RedshiftPortNumber
        SourceSecurityGroupId: !Ref AppSecurityGroup
        Description: App Security Group
      VpcId: !Ref VPC
  QSingressRule:
    Type: AWS::EC2::SecurityGroupIngress
    Condition: isQuickSightRegionIP
    Properties: 
      CidrIp: !FindInMap
              - AWSQuickSightIPMap
              - !Ref 'AWS::Region'
              - QuickSightIP
      Description: Amazon QuickSight access
      FromPort: 
        Ref: RedshiftPortNumber
      ToPort: 
        Ref: RedshiftPortNumber
      IpProtocol: tcp
      GroupId: !GetAtt RSDefaultSG.GroupId

  RedshiftDeliveryRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - firehose.amazonaws.com
                - redshift.amazonaws.com
            Action:
              - sts:AssumeRole
            Condition:
              StringEquals:
                sts:ExternalId: !Ref 'AWS::AccountId'
      Policies:
        - PolicyName: !Join
            - ''
            - - Redshift-Delivery-
              - !Ref 'AWS::StackName'
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: ''
                Effect: Allow
                Action:
                  - s3:AbortMultipartUpload
                  - s3:GetBucketLocation
                  - s3:GetObject
                  - s3:ListBucket
                  - s3:ListBucketMultipartUploads
                  - s3:PutObject
                  - s3:GetBucketAcl
                  - s3:ListAllMyBuckets
                Resource:
                  - !Join
                    - ''
                    - - 'arn:aws:s3:::'
                      - !Ref 'StreamingAnalyticsBucket'
                  - !Join
                    - ''
                    - - 'arn:aws:s3:::'
                      - !Ref 'StreamingAnalyticsBucket'
                      - /*
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:GenerateDataKey
                Resource:
                  - !If
                    - NoEncryption
                    - !Join
                      - ''
                      - - 'arn:aws:kms:'
                        - !Ref 'AWS::Region'
                        - ':'
                        - !Ref 'AWS::AccountId'
                        - :key/placeholder-kms-id
                    - !GetAtt 'EncryptionKey.Arn'
                Condition:
                  StringEquals:
                    kms:ViaService: !Join
                      - ''
                      - - s3.
                        - !Ref 'AWS::Region'
                        - .amazonaws.com
                  StringLike:
                    kms:EncryptionContext:aws:s3:arn: !Join
                      - ''
                      - - 'arn:aws:s3:::'
                        - !Ref 'StreamingAnalyticsBucket'
                        - /RedshiftDelivery/*
              - Sid: ''
                Effect: Allow
                Action:
                  - logs:PutLogEvents
                Resource:
                  - '*'
              - Sid: ''
                Effect: Allow
                Action:
                  - kinesis:Get*
                  - kinesis:Describe*
                  - lambda:InvokeFunction
                  - lambda:GetFunctionConfiguration
                  - glue:*
                  - cloudwatch:Get*
                  - cloudwatch:List*
                  - redshift:Describe*
                  - redshift:ModifyClusterIamRoles
                  - redshift:CreateCluster
                  - iam:List*
                  - iam:Get*
                  - ec2:Describe*
                  - cloudformation:DescribeStacks
                  - cloudformation:GetTemplateSummary
                Resource:
                  - '*'
  FIrehoseToRedshift:
    Type: AWS::KinesisFirehose::DeliveryStream
    DependsOn: RedshiftDeliveryRole
    Properties:
      RedshiftDestinationConfiguration:
        ClusterJDBCURL: !Sub "jdbc:redshift://${RedshiftCluster.Endpoint.Address}:${RedshiftCluster.Endpoint.Port}/${DatabaseName}"
        CopyCommand:
          CopyOptions: TIMEFORMAT 'auto' json 'auto' EMPTYASNULL ACCEPTINVCHARS ACCEPTANYDATE IGNOREHEADER AS 1
          DataTableName: !Ref 'RedshiftTableName'
        Password: !Ref 'MasterUserPassword'
        CloudWatchLoggingOptions:
          Enabled: true
          LogGroupName: !Ref RSCloudwatchLogsGroup
          LogStreamName: !Ref RSLogStream
        RoleARN: !GetAtt 'RedshiftDeliveryRole.Arn'
        S3Configuration:
          BucketARN: !Join
            - ''
            - - 'arn:aws:s3:::'
              - !Ref 'StreamingAnalyticsBucket'
          RoleARN: !GetAtt 'RedshiftDeliveryRole.Arn'
          BufferingHints:
            IntervalInSeconds: !Ref 'RedshiftBufferInterval'
            SizeInMBs: !Ref 'RedshiftBufferSize'
          CompressionFormat: UNCOMPRESSED
          EncryptionConfiguration:
            KMSEncryptionConfig: !If
              - NoEncryption
              - !Ref 'AWS::NoValue'
              - AWSKMSKeyARN: !GetAtt 'EncryptionKey.Arn'
            NoEncryptionConfig: !If
              - NoEncryption
              - NoEncryption
              - !Ref 'AWS::NoValue'
          Prefix: RedshiftDelivery/
        Username: !Ref 'MasterUser'
        
  AppNotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
        - Endpoint: !Ref 'OperatorEMail'
          Protocol: email
  AppNotificationTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
              - events.amazonaws.com
          Action: sns:Publish
          Resource: !Ref AppNotificationTopic
      Topics:
      - !Ref AppNotificationTopic
  AppServerGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Condition: isDemon
    DependsOn: RedshiftCluster
    CreationPolicy:
      ResourceSignal:
        Timeout: PT15M
        Count: 2
    UpdatePolicy:
      AutoScalingRollingUpdate:
        MaxBatchSize: 1
        MinInstancesInService: 1
        PauseTime: PT15M
        WaitOnResourceSignals: true
    Properties:
      VPCZoneIdentifier: 
        - !Ref 'PrivateSubnetA'
        - !Ref 'PrivateSubnetB'
      LaunchConfigurationName: !Ref 'LaunchConfig'
      MinSize: '2'
      MaxSize: '4'
      TargetGroupARNs:
        - !Ref TargetGroupPublic
      NotificationConfiguration:
        TopicARN: !Ref 'AppNotificationTopic'
        NotificationTypes:
          - autoscaling:EC2_INSTANCE_LAUNCH
          - autoscaling:EC2_INSTANCE_LAUNCH_ERROR
          - autoscaling:EC2_INSTANCE_TERMINATE
          - autoscaling:EC2_INSTANCE_TERMINATE_ERROR
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-AppServer
          PropagateAtLaunch: true
  LaunchConfig:
    Type: AWS::AutoScaling::LaunchConfiguration
    Condition: isDemon
    Metadata:
      Comment: Install Apache WebServer
      AWS::CloudFormation::Init:
        config:
          packages:
            yum:
              httpd: []
          files:
            /var/www/html/index.html:
              content: !Join
                - ''
                - - '<h1>Congratulations, you have successfully launched the AWS CloudFormation Clickstream Analytics quickstart template.</h1>'
              mode: '000644'
              owner: root
              group: root
            /etc/cfn/cfn-hup.conf:
              content: !Join
                - ''
                - - "[main]\n"
                  - stack=
                  - !Ref 'AWS::StackId'
                  - "\n"
                  - region=
                  - !Ref 'AWS::Region'
                  - "\n"
              mode: '000400'
              owner: root
              group: root
            /etc/cfn/hooks.d/cfn-auto-reloader.conf:
              content: !Join
                - ''
                - - "[cfn-auto-reloader-hook]\n"
                  - "triggers=post.update\n"
                  - "path=Resources.LaunchConfig.Metadata.AWS::CloudFormation::Init\n"
                  - 'action=/opt/aws/bin/cfn-init -v '
                  - '         --stack '
                  - !Ref 'AWS::StackName'
                  - '         --resource LaunchConfig '
                  - '         --region '
                  - !Ref 'AWS::Region'
                  - "\n"
                  - "runas=root\n"
          services:
            sysvinit:
              httpd:
                enabled: 'true'
                ensureRunning: 'true'
              cfn-hup:
                enabled: 'true'
                ensureRunning: 'true'
                files:
                  - /etc/cfn/cfn-hup.conf
                  - /etc/cfn/hooks.d/cfn-auto-reloader.conf        
          commands:
            redshift_cmd:
              command: !Sub |
                #!/bin/bash
                /usr/bin/sudo yum groupinstall -y "Development Tools"
                /usr/bin/sudo yum install -y postgresql-devel
                /usr/bin/sudo yum install -y postgresql-server
                /usr/bin/sudo /sbin/service postgresql initdb
                /usr/bin/sudo /etc/init.d/postgresql start
                export PGPASSWORD='${MasterUserPassword}' && psql -h ${RedshiftCluster.Endpoint.Address} -U ${MasterUser} -d ${DatabaseName} -p ${RedshiftCluster.Endpoint.Port} PGPASSWORD -c 'create schema if not exists apache_logs;'
                export PGPASSWORD='${MasterUserPassword}' && psql -h ${RedshiftCluster.Endpoint.Address} -U ${MasterUser} -d ${DatabaseName} -p ${RedshiftCluster.Endpoint.Port} PGPASSWORD -c 'create table apache_logs.access_logs (HOST VARCHAR(1000), IDENT VARCHAR(1000), AUTHUSER VARCHAR(1000), DATETIME TIMESTAMP, REQUEST VARCHAR(4000), RESPONSE VARCHAR(4000), BYTES VARCHAR(4000));'
                /usr/bin/sudo yum install -y aws-kinesis-agent
                /usr/bin/sudo /bin/chown -R aws-kinesis-agent-user:aws-kinesis-agent-user /var/log/httpd/
                /usr/bin/sudo /bin/mv /etc/aws-kinesis/agent.json /etc/aws-kinesis/agent.orig
                /usr/bin/sudo /bin/sh -c '/bin/cat >/etc/aws-kinesis/agent.json <<EOL
                {
                      "cloudwatch.emitMetrics": true,
                      "firehose.endpoint": "https://firehose.${AWS::Region}.amazonaws.com",
                      "kinesis.endpoint": "https://kinesis.${AWS::Region}.amazonaws.com",

                      "flows": [
                    {
                      "filePattern": "/var/log/httpd/access_log",
                      "initialPosition": "END_OF_FILE",
                      "deliveryStream": "${FIrehoseToRedshift}",
                      "dataProcessingOptions": [
                    {
                      "optionName": "LOGTOJSON",
                      "logFormat": "COMMONAPACHELOG"
                  }
                  ]
                  },
                  {
                      "filePattern": "/var/log/httpd/access_log",
                      "initialPosition": "END_OF_FILE",
                      "deliveryStream": "${FIrehoseToElasticsearch}",
                      "dataProcessingOptions": [
                    {
                      "optionName": "LOGTOJSON",
                      "logFormat": "COMMONAPACHELOG"
                  }
                  ]
                  }
                  ]
                }
                EOL'
                /usr/bin/sudo /sbin/service aws-kinesis-agent start
                /usr/bin/sudo /sbin/chkconfig aws-kinesis-agent on
                WebsiteContentURL=${WebsiteContent}
                if [ -z "$WebsiteContentURL" ]
                then
                    echo "WebsiteContentURL Variable is empty."
                else
                    /usr/bin/aws s3 sync s3://$WebsiteContentURL /var/www/html/
                fi
                /usr/bin/sudo /sbin/service httpd restart
    Properties:
      KeyName: !Ref 'AppKeyPairName'
      ImageId: !FindInMap
        - AWSRegionArch2AMI
        - !Ref 'AWS::Region'
        - !FindInMap
          - InstanceType2Arch
          - !Ref 'AppInstanceType'
          - Arch
      SecurityGroups:
        - !Ref 'AppSecurityGroup'
      IamInstanceProfile: !Ref 'AppInstanceProfile'
      InstanceType: !Ref 'AppInstanceType'
      UserData: !Base64
        Fn::Join:
          - ''
          - - "#!/bin/bash -xe\n"
            - "yum update -y aws-cfn-bootstrap\n"
            - '/opt/aws/bin/cfn-init -v '
            - '         --stack '
            - !Ref 'AWS::StackName'
            - '         --resource LaunchConfig '
            - '         --region '
            - !Ref 'AWS::Region'
            - "\n"
            - '/opt/aws/bin/cfn-signal -e $? '
            - '         --stack '
            - !Ref 'AWS::StackName'
            - '         --resource AppServerGroup '
            - '         --region '
            - !Ref 'AWS::Region'
            - "\n"
  AppServerGroupisDemos:
    Type: AWS::AutoScaling::AutoScalingGroup
    Condition: isDemos
    DependsOn: RedshiftCluster
    CreationPolicy:
      ResourceSignal:
        Timeout: PT15M
        Count: 2
    UpdatePolicy:
      AutoScalingRollingUpdate:
        MaxBatchSize: 1
        MinInstancesInService: 1
        PauseTime: PT15M
        WaitOnResourceSignals: true
    Properties:
      VPCZoneIdentifier: 
        - !Ref 'PrivateSubnetA'
        - !Ref 'PrivateSubnetB'
      LaunchConfigurationName: !Ref 'LaunchConfigisDemos'
      MinSize: '2'
      MaxSize: '4'
      TargetGroupARNs:
        - !Ref TargetGroupPublic
      NotificationConfiguration:
        TopicARN: !Ref 'AppNotificationTopic'
        NotificationTypes:
          - autoscaling:EC2_INSTANCE_LAUNCH
          - autoscaling:EC2_INSTANCE_LAUNCH_ERROR
          - autoscaling:EC2_INSTANCE_TERMINATE
          - autoscaling:EC2_INSTANCE_TERMINATE_ERROR
      Tags:
        - Key: Name
          Value: !Sub ${AWS::StackName}-AppServer
          PropagateAtLaunch: true
  LaunchConfigisDemos:
    Type: AWS::AutoScaling::LaunchConfiguration
    Condition: isDemos
    Metadata:
      Comment: Install Apache WebServer
      AWS::CloudFormation::Init:
        config:
          packages:
            yum:
              httpd: []
          files:
            /var/www/html/index.html:
              content: !Join
                - ''
                - - '<h1>Congratulations, you have successfully launched the AWS CloudFormation Clickstream Analytics quickstart template.</h1>'
              mode: '000644'
              owner: root
              group: root
            /etc/cfn/cfn-hup.conf:
              content: !Join
                - ''
                - - "[main]\n"
                  - stack=
                  - !Ref 'AWS::StackId'
                  - "\n"
                  - region=
                  - !Ref 'AWS::Region'
                  - "\n"
              mode: '000400'
              owner: root
              group: root
            /etc/cfn/hooks.d/cfn-auto-reloader.conf:
              content: !Join
                - ''
                - - "[cfn-auto-reloader-hook]\n"
                  - "triggers=post.update\n"
                  - "path=Resources.LaunchConfig.Metadata.AWS::CloudFormation::Init\n"
                  - 'action=/opt/aws/bin/cfn-init -v '
                  - '         --stack '
                  - !Ref 'AWS::StackName'
                  - '         --resource LaunchConfigisDemos '
                  - '         --region '
                  - !Ref 'AWS::Region'
                  - "\n"
                  - "runas=root\n"
          services:
            sysvinit:
              httpd:
                enabled: 'true'
                ensureRunning: 'true'
              cfn-hup:
                enabled: 'true'
                ensureRunning: 'true'
                files:
                  - /etc/cfn/cfn-hup.conf
                  - /etc/cfn/hooks.d/cfn-auto-reloader.conf
          commands:
            kinesis_agent_cmd:
              command: !Sub |
                #!/bin/bash -x
                /usr/bin/sudo yum install -y aws-kinesis-agent
                /usr/bin/sudo /bin/chown -R aws-kinesis-agent-user:aws-kinesis-agent-user /var/log/httpd/
                /usr/bin/sudo /bin/mv /etc/aws-kinesis/agent.json /etc/aws-kinesis/agent.orig
                /usr/bin/sudo /bin/sh -c '/bin/cat >/etc/aws-kinesis/agent.json <<EOL
                {
                      "cloudwatch.emitMetrics": true,
                      "firehose.endpoint": "https://firehose.${AWS::Region}.amazonaws.com",
                      "kinesis.endpoint": "https://kinesis.${AWS::Region}.amazonaws.com",
                      "flows": [
                   {
                      "filePattern": "/var/log/demodata/GADemoData.csv",
                      "initialPosition": "START_OF_FILE",
                      "deliveryStream": "${FIrehoseToElasticsearch}",
                      "dataProcessingOptions": [
                    {
                      "optionName": "CSVTOJSON",
                      "customFieldNames": [ "City", "Country/Region", "Date", "Number of Records", "Section", "Time on Page", "Total Downloads", "Unique", "Exits", "Date", "Medium", "Page", "Pageviews", "Visitors", "Visits" ],
                      "delimiter": "\\t"
                    }
                    ]
                    },
                    {
                      "filePattern": "/var/log/demodata/Schematic_Log.csv",
                      "initialPosition": "START_OF_FILE",
                      "deliveryStream": "${FIrehoseToElasticsearch}",
                      "dataProcessingOptions": [
                    {
                      "optionName": "CSVTOJSON",
                      "customFieldNames": [ "Action", "Bytes", "Item ", "# Of Purchases", "Response", "Pct_Purchase", "# Of Views", "Brand", "Clickhere", "ClientIP", "ItemID", "Number of Records", "Rbytes", "Rstat", "SessionID", "TimeStamp", "URL" ],
                      "delimiter": "\\t"
                    }
                    ]
                    },
                    {
                      "filePattern": "/var/log/httpd/access_log",
                      "initialPosition": "END_OF_FILE",
                      "deliveryStream": "${FIrehoseToRedshift}",
                      "dataProcessingOptions": [
                    {
                      "optionName": "LOGTOJSON",
                      "logFormat": "COMMONAPACHELOG"
                  }
                  ]
                  },
                  {
                      "filePattern": "/var/log/httpd/access_log",
                      "initialPosition": "END_OF_FILE",
                      "deliveryStream": "${FIrehoseToElasticsearch}",
                      "dataProcessingOptions": [
                    {
                      "optionName": "LOGTOJSON",
                      "logFormat": "COMMONAPACHELOG"
                   }
                   ]
                   }
                   ]
                 }
                 EOL'
                /usr/bin/sudo /sbin/service aws-kinesis-agent restart
                /usr/bin/sudo /sbin/chkconfig aws-kinesis-agent on
                /usr/bin/sudo service httpd restart
    Properties:
      KeyName: !Ref 'AppKeyPairName'
      ImageId: !FindInMap
        - AWSRegionArch2AMI
        - !Ref 'AWS::Region'
        - !FindInMap
          - InstanceType2Arch
          - !Ref 'AppInstanceType'
          - Arch
      SecurityGroups:
        - !Ref 'AppSecurityGroup'
      IamInstanceProfile: !Ref 'AppInstanceProfile'
      InstanceType: !Ref 'AppInstanceType'
      UserData: 
        Fn::Base64: 
          !Sub |
          #!/bin/bash -x
          yum update -y aws-cfn-bootstrap
          /usr/bin/sudo /usr/bin/pip install --upgrade awscli
          /usr/bin/sudo yum groupinstall -y "Development Tools"
          /usr/bin/sudo yum install -y jq
          /usr/bin/sudo yum install -y postgresql-devel
          /usr/bin/sudo yum install -y postgresql-server
          /usr/bin/sudo /sbin/service postgresql initdb
          /usr/bin/sudo /etc/init.d/postgresql restart
          /usr/bin/sudo mkdir -p /var/log/demodata
          /usr/bin/wget https://s3-us-west-2.amazonaws.com/ctepoc-clickctream-dataset/OtherClickStreamDataSets/GADemoData.csv
          /usr/bin/wget https://s3-us-west-2.amazonaws.com/ctepoc-clickctream-dataset/OtherClickStreamDataSets/Schematic_Log.csv
          /usr/bin/sudo /bin/mv ./GADemoData.csv ./Schematic_Log.csv /var/log/demodata
          /usr/bin/aws s3 sync /var/log/demodata/ s3://${StreamingAnalyticsBucket}/demodata --acl public-read
          WebsiteContentURL=${WebsiteContent}
          if [ -z "$WebsiteContentURL" ]
          then
               echo "WebsiteContentURL Variable is empty."
          else
               /usr/bin/aws s3 sync s3://$WebsiteContentURL /var/www/html/ && /usr/bin/sudo /sbin/service httpd restart
          fi
          /usr/bin/sudo /bin/chown -R aws-kinesis-agent-user:aws-kinesis-agent-user /var/log/demodata/
          source <(aws sts assume-role --role-arn arn:aws:iam::${AWS::AccountId}:role/${AppRole} --role-session-name "QuickStart" --duration-seconds 1900 | jq -r  '.Credentials | @sh "export AWS_SESSION_TOKEN=\(.SessionToken)\nexport AWS_ACCESS_KEY_ID=\(.AccessKeyId)\nexport AWS_SECRET_ACCESS_KEY=\(.SecretAccessKey) "')
          export PGPASSWORD='${MasterUserPassword}'
          psql -h ${RedshiftCluster.Endpoint.Address} -U ${MasterUser} -d ${DatabaseName} -p ${RedshiftCluster.Endpoint.Port} PGPASSWORD -c 'create schema if not exists apache_logs;'
          psql -h ${RedshiftCluster.Endpoint.Address} -U ${MasterUser} -d ${DatabaseName} -p ${RedshiftCluster.Endpoint.Port} PGPASSWORD -c 'create schema if not exists clickstream_demo;'
          psql -h ${RedshiftCluster.Endpoint.Address} -U ${MasterUser} -d ${DatabaseName} -p ${RedshiftCluster.Endpoint.Port} PGPASSWORD -c 'create table apache_logs.access_logs (HOST VARCHAR(1000), IDENT VARCHAR(1000), AUTHUSER VARCHAR(1000), DATETIME TIMESTAMP, REQUEST VARCHAR(4000), RESPONSE VARCHAR(4000), BYTES VARCHAR(4000));'
          psql -h ${RedshiftCluster.Endpoint.Address} -U ${MasterUser} -d ${DatabaseName} -p ${RedshiftCluster.Endpoint.Port} PGPASSWORD -c 'create table clickstream_demo.schematic_log(action varchar(100), bytes integer, item varchar(1000), number_of_purchases integer, response varchar(100), pct_purchase numeric(8,2), number_of_views integer, brand varchar(1000), clickhere varchar(1000), category varchar(1000), clientip varchar(1000), itemid varchar(1000), msg varchar(1000), number_of_records integer, productid varchar(1000), rbytes integer, rstat integer, serverip varchar(1000), sessionid varchar(1000), timestamp timestamp, url varchar(2000));'
          psql -h ${RedshiftCluster.Endpoint.Address} -U ${MasterUser} -d ${DatabaseName} -p ${RedshiftCluster.Endpoint.Port} PGPASSWORD -c 'create table clickstream_demo.ga_demo_data(city varchar(100), country_region varchar(1000), date date, exits integer,medium varchar(1000), number_of_records integer, page varchar(1000), pageviews integer, section varchar(1000), time_on_page integer, total_downloads integer, unique_visitors integer, visits integer);'
          psql -h ${RedshiftCluster.Endpoint.Address} -U ${MasterUser} -d ${DatabaseName} -p ${RedshiftCluster.Endpoint.Port} PGPASSWORD -c "copy clickstream_demo.schematic_log from 's3://${StreamingAnalyticsBucket}/demodata/Schematic_Log.csv' CREDENTIALS 'aws_access_key_id=$AWS_ACCESS_KEY_ID;aws_secret_access_key=$AWS_SECRET_ACCESS_KEY;token=$AWS_SESSION_TOKEN' delimiter ',' EMPTYASNULL ACCEPTINVCHARS ACCEPTANYDATE IGNOREHEADER AS 1;"
          psql -h ${RedshiftCluster.Endpoint.Address} -U ${MasterUser} -d ${DatabaseName} -p ${RedshiftCluster.Endpoint.Port} PGPASSWORD -c "copy clickstream_demo.ga_demo_data from 's3://${StreamingAnalyticsBucket}/demodata/GADemoData.csv' CREDENTIALS 'aws_access_key_id=$AWS_ACCESS_KEY_ID;aws_secret_access_key=$AWS_SECRET_ACCESS_KEY;token=$AWS_SESSION_TOKEN' delimiter '\t' EMPTYASNULL ACCEPTINVCHARS ACCEPTANYDATE IGNOREHEADER AS 1;"
          /opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource LaunchConfigisDemos --region ${AWS::Region}
          /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackName} --resource AppServerGroupisDemos --region ${AWS::Region}

  AppServerScaleUpPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Condition: isDemon
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref 'AppServerGroup'
      Cooldown: '60'
      ScalingAdjustment: 1
  AppServerScaleDownPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Condition: isDemon
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref 'AppServerGroup'
      Cooldown: '60'
      ScalingAdjustment: -1
  CPUAlarmHigh:
    Type: AWS::CloudWatch::Alarm
    Condition: isDemon
    Properties:
      AlarmDescription: Scale-up if CPU > 90% for 10 minutes
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 90
      AlarmActions:
        - !Ref 'AppServerScaleUpPolicy'
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref 'AppServerGroup'
      ComparisonOperator: GreaterThanThreshold
  CPUAlarmLow:
    Type: AWS::CloudWatch::Alarm
    Condition: isDemon
    Properties:
      AlarmDescription: Scale-down if CPU < 70% for 10 minutes
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 70
      AlarmActions:
        - !Ref 'AppServerScaleDownPolicy'
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref 'AppServerGroup'
      ComparisonOperator: LessThanThreshold
  AppServerScaleUpPolicyisDemos:
    Type: AWS::AutoScaling::ScalingPolicy
    Condition: isDemos
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref 'AppServerGroupisDemos'
      Cooldown: '60'
      ScalingAdjustment: 1
  AppServerScaleDownPolicyisDemos:
    Type: AWS::AutoScaling::ScalingPolicy
    Condition: isDemos
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref 'AppServerGroupisDemos'
      Cooldown: '60'
      ScalingAdjustment: -1
  CPUAlarmHighisDemos:
    Type: AWS::CloudWatch::Alarm
    Condition: isDemos
    Properties:
      AlarmDescription: Scale-up if CPU > 90% for 10 minutes
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 90
      AlarmActions:
        - !Ref 'AppServerScaleUpPolicyisDemos'
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref 'AppServerGroupisDemos'
      ComparisonOperator: GreaterThanThreshold
  CPUAlarmLowisDemos:
    Type: AWS::CloudWatch::Alarm
    Condition: isDemos
    Properties:
      AlarmDescription: Scale-down if CPU < 70% for 10 minutes
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 70
      AlarmActions:
        - !Ref 'AppServerScaleDownPolicyisDemos'
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref 'AppServerGroupisDemos'
      ComparisonOperator: LessThanThreshold
  PublicLoadBalancerSG:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Public LoadBalancer Security Group
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
  PublicLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Scheme: internet-facing
      LoadBalancerAttributes:
      - Key: idle_timeout.timeout_seconds
        Value: '30'
      Subnets:
        - !Ref PublicSubnetA
        - !Ref PublicSubnetB
      SecurityGroups: [!Ref 'PublicLoadBalancerSG']
  TargetGroupPublic:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      HealthCheckIntervalSeconds: 30
      HealthCheckPath: /
      HealthCheckProtocol: HTTP
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 5
      Protocol: HTTP
      Port: 80
      UnhealthyThresholdCount: 2
      VpcId: !Ref VPC
  PublicLoadBalancerListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    DependsOn:
      - PublicLoadBalancer
    Properties:
      DefaultActions:
        - TargetGroupArn: !Ref 'TargetGroupPublic'
          Type: 'forward'
      LoadBalancerArn: !Ref 'PublicLoadBalancer'
      Port: 80
      Protocol: HTTP
  BastionNotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
        - Endpoint: !Ref 'OperatorEMail'
          Protocol: email
  BastionNotificationTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
              - events.amazonaws.com
          Action: sns:Publish
          Resource: !Ref BastionNotificationTopic
      Topics:
      - !Ref BastionNotificationTopic

  ESCloudwatchLogsGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 3653
  ESLogStream: 
    Type: AWS::Logs::LogStream
    Properties: 
      LogGroupName: !Ref ESCloudwatchLogsGroup
      LogStreamName: elasticsearch
  RSCloudwatchLogsGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 3653
  RSLogStream: 
    Type: AWS::Logs::LogStream
    Properties: 
      LogGroupName: !Ref RSCloudwatchLogsGroup
      LogStreamName: redshift
  S3CloudwatchLogsGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 3653
  S3LogStream: 
    Type: AWS::Logs::LogStream
    Properties: 
      LogGroupName: !Ref S3CloudwatchLogsGroup
      LogStreamName: S3

Outputs:
  VPCID:
    Value: !Ref VPC
  PublicSubnetA:
    Value: !Ref PublicSubnetA
  PublicSubnetB:
    Value: !Ref PublicSubnetB
  PrivateSubnetA:
    Value: !Ref PrivateSubnetA
  PrivateSubnetB:
    Value: !Ref PrivateSubnetB
  BastionSecurityGroup:
    Value: !GetAtt BastionStack.Outputs.BastionSecurityGroupID
  AppSecurityGroup:
    Value: !Ref AppSecurityGroup
  InstanceProfile:
    Value: !Ref AppInstanceProfile
  S3Bucket:
    Value: !Ref StreamingAnalyticsBucket
  S3DeliveryStream:
    Value: !Ref FIrehoseToS3
  ElasticSearchDomainName:
    Value: !Ref ESDomainName
  ElasticSearchDomainEndpoint:
    Value: !GetAtt ESDomain.DomainEndpoint
  ElasticSearchKibanaEndpoint:
    Value: !Sub "https://${ESDomain.DomainEndpoint}/_plugin/kibana/"
  ElasticSearchDeliveryStream:
    Value: !Ref FIrehoseToElasticsearch
  RedshiftCluster:
    Value: !Ref RedshiftCluster
  RedshiftDeliveryStream:
    Value: !Ref FIrehoseToRedshift
  RedshiftJDBCURL:
    Value: !Sub "jdbc:redshift://${RedshiftCluster.Endpoint.Address}:${RedshiftCluster.Endpoint.Port}/${DatabaseName}"
  LoadBalancerSecurityGroup:
    Value: !Ref PublicLoadBalancerSG
  LoadBalancerDNS:
    Value: !GetAtt PublicLoadBalancer.DNSName
  LoadBalancerDNSEndpoint:
    Value: !Sub 'http://${PublicLoadBalancer.DNSName}'
