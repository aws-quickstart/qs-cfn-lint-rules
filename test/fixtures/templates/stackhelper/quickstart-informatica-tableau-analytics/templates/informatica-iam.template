{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"This template creates IAM roles and profiles for use by EC2 instances.  **WARNING** This template creates Amazon EC2 instance and related resources. You will be billed for the AWS resources used if you create a stack from this template.",
   "Parameters":{
      "QSS3BucketName":{
         "Default":"aws-quickstart-informatica-tableau",
         "Description":"S3 bucket name for the Quick Start assets. Quick Start bucket name can include numbers, lowercase letters, uppercase letters, periods (.), and hyphens (-). It cannot start or end with a hyphen (-).",
         "Type":"String"
      },
      "QSS3KeyPrefix":{
         "Default":"",
         "Description":"S3 key prefix for the Quick Start assets. Quick Start key prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/).  Prefix cannot start with a slash but must end with a slash unless it is the empty string.",
         "Type":"String"
      },
      "StackRoot":{
         "Description":"Root of the stack name used to limit Cloud Formation Describe command access",
         "Type":"String"
      },
      "IICSTaskBucketName":{
         "Description":"S3 Bucket Name used for Informatica Intelligent Cloud Services Mapping Jobs",
         "Type":"String"
      },
      "InformaticaInstallationBucket":{
         "Description":"S3 Bucket Name used to setup Informatica trial and setting up dashboards",
         "Type":"String"
      }
   },
   "Mappings":{

   },
   "Conditions":{

   },
   "Resources":{
      "InstanceRole":{
         "Type":"AWS::IAM::Role",
         "Properties":{
            "AssumeRolePolicyDocument":{
               "Statement":[
                  {
                     "Action":[
                        "sts:AssumeRole"
                     ],
                     "Effect":"Allow",
                     "Principal":{
                        "Service":[
                           "ec2.amazonaws.com"
                        ]
                     }
                  }
               ],
               "Version":"2012-10-17"
            },
            "Path":"/informatica/",
            "Policies":[
               {
                  "PolicyName":"QuickstartBucketAccess",
                  "PolicyDocument":{
                     "Statement":[
                        {
                           "Effect":"Allow",
                           "Action":[
                              "s3:ListBucket"
                           ],
                           "Resource":[
                              {
                                 "Fn::Sub":"arn:aws:s3:::${QSS3BucketName}"
                              }
                           ]
                        },
                        {
                           "Action":[
                              "s3:GetObject"
                           ],
                           "Effect":"Allow",
                           "Resource":[
                              {
                                 "Fn::Sub":"arn:aws:s3:::${QSS3BucketName}/${QSS3KeyPrefix}*"
                              }
                           ]
                        },
                        {
                           "Effect":"Allow",
                           "Action":[
                              "s3:List*",
                              "s3:Get*",
                              "s3:Put*"
                           ],
                           "Resource":[
                              {
                                 "Fn::Sub":"arn:aws:s3:::${IICSTaskBucketName}"
                              }
                           ]
                        },
                        {
                           "Effect":"Allow",
                           "Action":[
                              "s3:List*",
                              "s3:Get*",
                              "s3:Put*"
                           ],
                           "Resource":[
                              {
                                 "Fn::Sub":"arn:aws:s3:::${IICSTaskBucketName}/*"
                              }
                           ]
                        },
                        {
                           "Effect":"Allow",
                           "Action":[
                              "s3:List*",
                              "s3:Get*",
                              "s3:Put*"
                           ],
                           "Resource":[
                              {
                                 "Fn::Sub":"arn:aws:s3:::${InformaticaInstallationBucket}"
                              }
                           ]
                        },
                        {
                           "Effect":"Allow",
                           "Action":[
                              "s3:List*",
                              "s3:Get*",
                              "s3:Put*"
                           ],
                           "Resource":[
                              {
                                 "Fn::Sub":"arn:aws:s3:::${InformaticaInstallationBucket}/*"
                              }
                           ]
                        },
                        {
                           "Effect":"Allow",
                           "Action":[
                              "cloudformation:Describe*",
                              "cloudformation:List*",
                              "cloudformation:Get*",
                              "cloudformation:SignalResource*"
                           ],
                           "Resource":{
                              "Fn::Sub":"arn:aws:cloudformation:${AWS::Region}:${AWS::AccountId}:stack/${StackRoot}*/*"
                           }
                        }
                     ]
                  }
               }
            ]
         }
      },
      "CloudWatchPolicies":{
         "Type":"AWS::IAM::ManagedPolicy",
         "Properties":{
            "PolicyDocument":{
               "Version":"2012-10-17",
               "Statement":[
                  {
                     "Action":[
                        "logs:*"
                     ],
                     "Effect":"Allow",
                     "Resource":"*"
                  }
               ]
            },
            "Roles":[
               {
                  "Ref":"InstanceRole"
               }
            ]
         }
      },
      "InstanceProfile":{
         "Type":"AWS::IAM::InstanceProfile",
         "Properties":{
            "Path":"/informatica/",
            "Roles":[
               {
                  "Ref":"InstanceRole"
               }
            ]
         }
      }
   },
   "Outputs":{
      "InstanceRole":{
         "Value":{
            "Ref":"InstanceRole"
         },
         "Description":"IAM Role for Informatica EC2 instances",
         "Export":{
            "Name":{
               "Fn::Sub":"${AWS::StackName}:InstanceRole"
            }
         }
      },
      "InstanceProfile":{
         "Value":{
            "Ref":"InstanceProfile"
         },
         "Description":"Informatica Instance Profile",
         "Export":{
            "Name":{
               "Fn::Sub":"${AWS::StackName}:InstanceProfile"
            }
         }
      }
   }
}
