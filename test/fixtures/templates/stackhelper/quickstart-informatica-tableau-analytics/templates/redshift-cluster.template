{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Creates a RedShift cluster within a VPC.  **WARNING** This template creates an Amazon Redshift cluster of the size and instance type that you specify. You will be billed for the AWS resources used if you create a stack from this template.",
   "Parameters":{
      "VPC":{
         "Type":"String",
         "Description":"ID of the Cage's Virtual Private Cloud"
      },
      "ClusterSubnetID":{
         "Type":"String",
         "Description":"SubnetId of an existing subnet in your Virtual Private Cloud (VPC)"
      },
      "DatabaseName":{
         "Description":"The name of the first database to be created when the Redshift cluster is created",
         "Type":"String",
         "Default":"quickstart"
      },
      "ClusterType":{
         "Description":"The type of the cluster",
         "Type":"String",
         "Default":"single-node"
      },
      "NumberOfNodes":{
         "Description":"The number of compute nodes in the Redshift cluster.  When cluster type is specified as single-node, the NumberOfNodes parameter should be specified as 1.  When cluster type is specified as multi-node, the NumberOfNodes parameter should be greater than 1",
         "Type":"Number",
         "Default":"2"
      },
      "NodeType":{
         "Description":"The node type to be provisioned for the Redshift cluster",
         "Type":"String",
         "Default":"dc1.large"
      },
      "MasterUsername":{
         "Description":"The user name associated with the master user account for the Redshift cluster that is being created",
         "Type":"String"
      },
      "MasterUserPassword":{
         "Description":"The password associated with the master user account for the Redshift cluster that is being created. ",
         "Type":"String",
         "NoEcho":"true"
      },
      "InboundTraffic":{
         "Description":"Make redshift accessible traffic to the cluster from VPC CIDR range.",
         "Type":"String"
      },
      "DatabasePort":{
         "Description":"The port that Redshift will listen on and that will be allowed through the Security Group. ",
         "Type":"String",
         "Default":"5439"
      }
   },
   "Conditions":{
      "IsMultiNodeCluster":{
         "Fn::Equals":[
            {
               "Ref":"ClusterType"
            },
            "multi-node"
         ]
      }
   },
   "Resources":{
      "SecurityGroup":{
         "Type":"AWS::EC2::SecurityGroup",
         "Properties":{
            "VpcId":{
               "Ref":"VPC"
            },
            "GroupDescription":"Security group",
            "SecurityGroupIngress":[
               {
                  "CidrIp":{
                     "Ref":"InboundTraffic"
                  },
                  "FromPort":{
                     "Ref":"DatabasePort"
                  },
                  "ToPort":{
                     "Ref":"DatabasePort"
                  },
                  "IpProtocol":"tcp"
               }
            ]
         }
      },
      "ClusterSubnetGroup":{
         "Type":"AWS::Redshift::ClusterSubnetGroup",
         "Properties":{
            "Description":"RedshiftClusterSubnetGroup",
            "SubnetIds":[
               {
                  "Ref":"ClusterSubnetID"
               }
            ]
         }
      },
      "RedshiftCluster":{
         "Type":"AWS::Redshift::Cluster",
         "DependsOn":"ClusterSubnetGroup",
         "Properties":{
            "ClusterType":{
               "Ref":"ClusterType"
            },
            "NumberOfNodes":{
               "Fn::If":[
                  "IsMultiNodeCluster",
                  {
                     "Ref":"NumberOfNodes"
                  },
                  {
                     "Ref":"AWS::NoValue"
                  }
               ]
            },
            "NodeType":{
               "Ref":"NodeType"
            },
            "DBName":{
               "Ref":"DatabaseName"
            },
            "MasterUsername":{
               "Ref":"MasterUsername"
            },
            "MasterUserPassword":{
               "Ref":"MasterUserPassword"
            },
            "PubliclyAccessible":"false",
            "Port":{
               "Ref":"DatabasePort"
            },
            "VpcSecurityGroupIds":[
               {
                  "Ref":"SecurityGroup"
               }
            ],
            "ClusterSubnetGroupName":{
               "Ref":"ClusterSubnetGroup"
            }
         }
      }
   },
   "Outputs":{
      "RedshiftHost":{
         "Value":{
            "Fn::GetAtt":[
               "RedshiftCluster",
               "Endpoint.Address"
            ]
         },
         "Description":"Redshift Cluster host"
      },
      "RedshiftPort":{
         "Value":{
            "Fn::GetAtt":[
               "RedshiftCluster",
               "Endpoint.Port"
            ]
         },
         "Description":"Redshift Cluster host"
      },
      "RedshiftDatabaseName":{
         "Value":{
            "Ref":"DatabaseName"
         }
      },
      "RedshiftUsername":{
         "Value":{
            "Ref":"MasterUsername"
         }
      },
      "RedshiftPassword":{
         "Value":{
            "Ref":"MasterUserPassword"
         }
      },
      "RedshiftClusterId":{
         "Value":{
            "Ref":"RedshiftCluster"
         }
      }
   }
}
