{
   "AWSTemplateFormatVersion":"2010-09-09",
   "Description":"Create Informatica IHS Node required for EDC",
   "Parameters":{
      "InstanceProfile":{
         "Description":"Informatica Server EC2 Instance Profile",
         "Type":"String"
      },
      "KeyPairName":{
         "Description":"Name of an existing Amazon EC2 keypair. You must specify this option to enable SSH access to Informatica domain and cluster instances",
         "Type":"AWS::EC2::KeyPair::KeyName"
      },
      "NetworkInterface":{
         "Description":"Network Interface for Hadoop Node",
         "Type":"String"
      }
   },
   "Mappings":{
      "AWSAMIRegionMap":{
         "AMI":{
            "INFAEICCLUSTERHVM":"Informatica Hadoop-Cluster Image for EDC Hadoop  Node"
         },
         "ap-northeast-1":{
            "INFAEICCLUSTERHVM":"ami-01be6be01dab79f0c"
         },
         "ap-northeast-2":{
            "INFAEICCLUSTERHVM":"ami-0c8aa51eaee4a8e41"
         },
         "ap-south-1":{
            "INFAEICCLUSTERHVM":"ami-0f706b7689f47eba2"
         },
         "ap-southeast-1":{
            "INFAEICCLUSTERHVM":"ami-052894ee1437d42a1"
         },
         "ap-southeast-2":{
            "INFAEICCLUSTERHVM":"ami-0fe3e5d0c0f9aebb4"
         },
         "ca-central-1":{
            "INFAEICCLUSTERHVM":"ami-0623eb9088bc1bc55"
         },
         "eu-central-1":{
            "INFAEICCLUSTERHVM":"ami-0dced899c9bf55c97"
         },
         "eu-west-1":{
            "INFAEICCLUSTERHVM":"ami-014f2ea69ec59ebc4"
         },
         "eu-west-2":{
            "INFAEICCLUSTERHVM":"ami-0417aec24a4922230"
         },
         "sa-east-1":{
            "INFAEICCLUSTERHVM":"ami-0aba311d51ceff279"
         },
         "us-east-1":{
            "INFAEICCLUSTERHVM":"ami-0f87b462d5146c6a0"
         },
         "us-east-2":{
            "INFAEICCLUSTERHVM":"ami-0b889cdd92955993f"
         },
         "us-west-1":{
            "INFAEICCLUSTERHVM":"ami-02bf673ae10bb4cbf"
         },
         "us-west-2":{
            "INFAEICCLUSTERHVM":"ami-05c6d148e8a3bccc9"
         }
      }
   },
   "Conditions":{

   },
   "Resources":{
      "WaitForClusterInstancesHandle":{
         "Type":"AWS::CloudFormation::WaitConditionHandle",
         "Properties":{

         }
      },
      "WaitForClusterInstancesCondition":{
         "Type":"AWS::CloudFormation::WaitCondition",
         "Properties":{
            "Count":1,
            "Handle":{
               "Ref":"WaitForClusterInstancesHandle"
            },
            "Timeout":"3600"
         }
      },
	  "IHSRecoveryTestAlarm": {
      "Type": "AWS::CloudWatch::Alarm",
      "Properties": {
        "AlarmDescription": "Trigger a recovery when IHS instance status check fails for 5 consecutive minutes.",
        "Namespace": "AWS/EC2" ,
        "MetricName": "StatusCheckFailed_System",
        "Statistic": "Minimum",
        "Period": "60",
        "EvaluationPeriods": "5",
        "ComparisonOperator": "GreaterThanThreshold",
        "Threshold": "0",
        "AlarmActions": [ {"Fn::Join" : ["", ["arn:aws:automate:", { "Ref" : "AWS::Region" }, ":ec2:recover" ]]} ],
        "Dimensions": [{"Name": "InstanceId","Value": {"Ref": "HadoopGateway"}}]
      }
    },
      "HadoopGateway":{
         "Type":"AWS::EC2::Instance",
         "Properties":{
            "IamInstanceProfile":{
               "Ref":"InstanceProfile"
            },
            "ImageId":{
               "Fn::FindInMap":[
                  "AWSAMIRegionMap",
                  {
                     "Ref":"AWS::Region"
                  },
                  "INFAEICCLUSTERHVM"
               ]
            },
            "InstanceType":"c4.8xlarge",
            "KeyName":{
               "Ref":"KeyPairName"
            },
            "InstanceInitiatedShutdownBehavior":"stop",
            "NetworkInterfaces":[
               {
                  "NetworkInterfaceId":{
                     "Ref":"NetworkInterface"
                  },
                  "DeviceIndex":"0"
               }
            ],
            "Tags":[
               {
                  "Key":"Name",
                  "Value":"HadoopGateway-HadoopNode-1"
               }
            ],
            "UserData":{
               "Fn::Base64":{
                  "Fn::Join":[
                     "",
                     [
                        "#!/bin/bash\n",
                        "function error_exit\n",
                        "{\n",
                        " /opt/aws/bin/cfn-signal -e 1 '",
                        {
                           "Ref":"WaitForClusterInstancesHandle"
                        },
                        "'\n",
                        " exit 1\n",
                        "}\n",
                        "\n",
                        " sudo yum update -y aws-cfn-bootstrap || error_exit\n",
                        "# Install the files and packages from the metadata\n",
                        " sudo yum install -y python-devel-2.7.5-34.el7.x86_64 || error_exit\n",
                        " echo 'exclude=python*' >> /etc/yum.conf \n",
                        " sudo /home/ec2-user/Mercury_Setup/replaceHostname.sh || error_exit\n",
                        "\n",
                        " response=$(sudo /bin/systemctl status sshd.service || error_exit)\n",
                        " if echo \"$response\" | grep -q \"running\"; then\n",
                        "    echo sshd service is running\n",
                        " else\n",
                        "    sudo /bin/systemctl start sshd.service || error_exit\n",
                        " fi\n",
                        "# Signal the status from cfn-init\n",
                        "\n",
                        " /opt/aws/bin/cfn-signal -e 0 '",
                        {
                           "Ref":"WaitForClusterInstancesHandle"
                        },
                        "'\n"
                     ]
                  ]
               }
            }
         }
      }
   },
   "Outputs":{
      "HadoopGateway":{
         "Value":{
            "Ref":"HadoopGateway"
         },
         "Description":"Instance ID of the IHS Node",
         "Export":{
            "Name":{
               "Fn::Sub":"${AWS::StackName}:HadoopGateway"
            }
         }
      },
      "HadoopGatewayPublicDNSName":{
         "Value":{
            "Fn::GetAtt":[
               "HadoopGateway",
               "PublicDnsName"
            ]
         },
         "Description":"Public DNS Name of the IHS EC2 instances",
         "Export":{
            "Name":{
               "Fn::Sub":"${AWS::StackName}:HadoopGatewayPublicDNSName"
            }
         }
      },
      "HadoopGatewayPrivateDNSName":{
         "Value":{
            "Fn::GetAtt":[
               "HadoopGateway",
               "PrivateDnsName"
            ]
         },
         "Description":"Private DNS Name of the IHS EC2 instances",
         "Export":{
            "Name":{
               "Fn::Sub":"${AWS::StackName}:HadoopGatewayPrivateDNSName"
            }
         }
      },
      "HadoopGatewayPrivateIp":{
         "Value":{
            "Fn::GetAtt":[
               "HadoopGateway",
               "PrivateIp"
            ]
         },
         "Description":"Private IP of IHS EC2 instances",
         "Export":{
            "Name":{
               "Fn::Sub":"${AWS::StackName}:HadoopGatewayPrivateIp"
            }
         }
      }
   }
}
